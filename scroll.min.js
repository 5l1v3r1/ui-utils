/**
 * angular-ui-utils - Swiss-Army-Knife of AngularJS tools (with no external dependencies!)
 * @version v0.1.1 - 2014-08-07
 * @link http://angular-ui.github.com
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
"use strict";angular.module("ui.scroll",[]).directive("uiScrollViewport",["$log",function(){return{controller:["$scope","$element",function(a,b){return b}]}}]).directive("uiScroll",["$log","$injector","$rootScope","$timeout",function(a,b,c,d){return{require:["?^uiScrollViewport"],transclude:"element",priority:1e3,terminal:!0,compile:function(e,f,g){return function(e,f,h,i){var j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,$,_,ab,bb;if(I=a.debug||a.log,J=h.uiScroll.match(/^\s*(\w+)\s+in\s+(\w+)\s*$/),!J)throw new Error("Expected uiScroll in form of '_item_ in _datasource_' but got '"+h.uiScroll+"'");if(G=J[1],u=J[2],E=function(a){return angular.isObject(a)&&a.get&&angular.isFunction(a.get)},t=e[u],!E(t)&&(t=b.get(u),!E(t)))throw new Error(""+u+" is not a valid datasource");return q=Math.max(3,+h.bufferSize||10),p=function(){return _.outerHeight()*Math.max(.1,+h.padding||.1)},R=function(a){var b;return null!=(b=a[0].scrollHeight)?b:a[0].document.documentElement.scrollHeight},j=null,g(V=e.$new(),function(a){var b,c,d,e,g,h;if(e=a[0].localName,"dl"===e)throw new Error("ui-scroll directive does not support <"+a[0].localName+"> as a repeating tag: "+a[0].outerHTML);return"li"!==e&&"tr"!==e&&(e="div"),h=i[0]||angular.element(window),h.css({"overflow-y":"auto",display:"block"}),d=function(a){var b,c,d;switch(a){case"tr":return d=angular.element("<table><tr><td><div></div></td></tr></table>"),b=d.find("div"),c=d.find("tr"),c.paddingHeight=function(){return b.height.apply(b,arguments)},c;default:return c=angular.element("<"+a+"></"+a+">"),c.paddingHeight=c.height,c}},c=function(a,b,c){return b[{top:"before",bottom:"after"}[c]](a),{paddingHeight:function(){return a.paddingHeight.apply(a,arguments)},insert:function(b){return a[{top:"after",bottom:"before"}[c]](b)}}},g=c(d(e),f,"top"),b=c(d(e),f,"bottom"),V.$destroy(),j={viewport:h,topPadding:g.paddingHeight,bottomPadding:b.paddingHeight,append:b.insert,prepend:g.insert,bottomDataPos:function(){return R(h)-b.paddingHeight()},topDataPos:function(){return g.paddingHeight()}}}),_=j.viewport,ab=_.scope()||c,angular.isDefined(h.topVisible)&&(Y=function(a){return ab[h.topVisible]=a}),angular.isDefined(h.topVisibleElement)&&(X=function(a){return ab[h.topVisibleElement]=a}),angular.isDefined(h.topVisibleScope)&&($=function(a){return ab[h.topVisibleScope]=a}),W=function(a){return Y&&Y(a.scope[G]),X&&X(a.element),$&&$(a.scope),t.topVisible?t.topVisible(a):void 0},H=angular.isDefined(h.isLoading)?function(a){return ab[h.isLoading]=a,t.loading?t.loading(a):void 0}:function(a){return t.loading?t.loading(a):void 0},P=0,B=1,K=1,o=[],L=[],x=!1,m=!1,F=!1,N=function(a,b){var c,d;for(c=d=a;b>=a?b>d:d>b;c=b>=a?++d:--d)o[c].scope.$destroy(),o[c].element.remove();return o.splice(a,b-a)},M=function(){return P++,B=1,K=1,N(0,o.length),j.topPadding(0),j.bottomPadding(0),L=[],x=!1,m=!1,k(P,!1)},n=function(){return _.scrollTop()+_.outerHeight()},Z=function(){return _.scrollTop()},S=function(){return!x&&j.bottomDataPos()<n()+p()},r=function(){var a,b,c,d,e,f,g,h,i,k;for(a=0,g=0,b=i=k=o.length-1;0>=k?0>=i:i>=0;b=0>=k?++i:--i)if(c=o[b],e=c.element.offset().top,f=h!==e,h=e,f&&(d=c.element.outerHeight(!0)),j.bottomDataPos()-a-d>n()+p())f&&(a+=d),g++,x=!1;else{if(f)break;g++}return g>0?(j.bottomPadding(j.bottomPadding()+a),N(o.length-g,o.length),K-=g,I("clipped off bottom "+g+" bottom padding "+j.bottomPadding())):void 0},T=function(){return!m&&j.topDataPos()>Z()-p()},s=function(){var a,b,c,d,e,f,g,h,i;for(g=0,e=0,h=0,i=o.length;i>h;h++)if(a=o[h],c=a.element.offset().top,d=f!==c,f=c,d&&(b=a.element.outerHeight(!0)),j.topDataPos()+g+b<Z()-p())d&&(g+=b),e++,m=!1;else{if(d)break;e++}return e>0?(j.topPadding(j.topPadding()+g),N(0,e),B+=e,I("clipped off top "+e+" top padding "+j.topPadding())):void 0},w=function(a,b,c){return F||(F=!0,H(!0)),1===L.push(b)?z(a,c):void 0},C=function(a){return a.displayTemp=a.css("display"),a.css("display","none")},U=function(a){return a.hasOwnProperty("displayTemp")?a.css("display",a.displayTemp):void 0},D=function(a,b){var c,d,f;return c=e.$new(),c[G]=b,d=a>B,c.$index=a,d&&c.$index--,f={scope:c},g(c,function(b){return f.element=b,d?a===K?(C(b),j.append(b),o.push(f)):(o[a-B].element.after(b),o.splice(a-B+1,0,f)):(C(b),j.prepend(b),o.unshift(f))}),{appended:d,wrapper:f}},l=function(a,b){var c;return a?j.bottomPadding(Math.max(0,j.bottomPadding()-b.element.outerHeight(!0))):(c=j.topPadding()-b.element.outerHeight(!0),c>=0?j.topPadding(c):_.scrollTop(_.scrollTop()+b.element.outerHeight(!0)))},v=function(a,b,c){var d,e,f,g,h,i,k,l,m;if(I("top {actual="+j.topDataPos()+" visible from="+Z()+" bottom {visible through="+n()+" actual="+j.bottomDataPos()+"}"),S()?w(a,!0,b):T()&&w(a,!1,b),c&&c(a),0===L.length){for(i=0,m=[],k=0,l=o.length;l>k;k++){if(d=o[k],f=d.element.offset().top,g=h!==f,h=f,g&&(e=d.element.outerHeight(!0)),!(g&&j.topDataPos()+i+e<Z())){g&&W(d);break}m.push(i+=e)}return m}},k=function(a,b,c,e){return c&&c.length?d(function(){var d,g,h,i,j,k,m,n;for(i=[],j=0,m=c.length;m>j;j++)g=c[j],f=g.wrapper.element,U(f),d=f.offset().top,h!==d&&(i.push(g),h=d);for(k=0,n=i.length;n>k;k++)g=i[k],l(g.appended,g.wrapper);return v(a,b,e)}):v(a,b,e)},A=function(a,b,c){return k(a,b,c,function(){return L.shift(),0===L.length?(F=!1,H(!1)):z(a,b)})},z=function(a,b){var c;return c=L[0],c?o.length&&!S()?A(a,b):t.get(K,q,function(c){var d,e,f,g;if(!a||a===P){if(e=[],c.length<q&&(x=!0,j.bottomPadding(0)),c.length>0)for(s(),f=0,g=c.length;g>f;f++)d=c[f],e.push(D(++K,d));return A(a,b,e)}}):o.length&&!T()?A(a,b):t.get(B-q,q,function(c){var d,e,f,g;if(!a||a===P){if(e=[],c.length<q&&(m=!0,j.topPadding(0)),c.length>0)for(o.length&&r(),d=f=g=c.length-1;0>=g?0>=f:f>=0;d=0>=g?++f:--f)e.unshift(D(--B,c[d]));return A(a,b,e)}})},O=function(){return c.$$phase||F?void 0:(k(null,!1),e.$apply())},_.bind("resize",O),Q=function(){return c.$$phase||F?void 0:(k(null,!0),e.$apply())},_.bind("scroll",Q),bb=function(a){var b,c;return b=_[0].scrollTop,c=_[0].scrollHeight-_[0].clientHeight,0===b&&!m||b===c&&!x?a.preventDefault():void 0},_.bind("mousewheel",bb),e.$watch(t.revision,function(){return M()}),y=t.scope?t.scope.$new():e.$new(),e.$on("$destroy",function(){return y.$destroy(),_.unbind("resize",O),_.unbind("scroll",Q),_.unbind("mousewheel",bb)}),y.$on("update.items",function(a,b,c){var d,e,f,g,h;if(angular.isFunction(b))for(e=function(a){return b(a.scope)},f=0,g=o.length;g>f;f++)d=o[f],e(d);else 0<=(h=b-B-1)&&h<o.length&&(o[b-B-1].scope[G]=c);return null}),y.$on("delete.items",function(a,b){var c,d,e,f,g,h,i,j,l,m,n,p;if(angular.isFunction(b)){for(e=[],h=0,l=o.length;l>h;h++)d=o[h],e.unshift(d);for(g=function(a){return b(a.scope)?(N(e.length-1-c,e.length-c),K--):void 0},c=i=0,m=e.length;m>i;c=++i)f=e[c],g(f)}else 0<=(p=b-B-1)&&p<o.length&&(N(b-B-1,b-B),K--);for(c=j=0,n=o.length;n>j;c=++j)d=o[c],d.scope.$index=B+c;return k(null,!1)}),y.$on("insert.item",function(a,b,c){var d,e,f,g,h;if(e=[],angular.isFunction(b))throw new Error("not implemented - Insert with locator function");for(0<=(h=b-B-1)&&h<o.length&&(e.push(D(b,c)),K++),d=f=0,g=o.length;g>f;d=++f)c=o[d],c.scope.$index=B+d;return k(null,!1,e)})}}}}]);