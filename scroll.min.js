/**
 * angular-ui-utils - Swiss-Army-Knife of AngularJS tools (with no external dependencies!)
 * @version v0.1.1 - 2014-05-27
 * @link http://angular-ui.github.com
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
"use strict";angular.module("ui.scroll",[]).directive("uiScrollViewport",["$log",function(){return{controller:["$scope","$element",function(a,b){return b}]}}]).directive("uiScroll",["$log","$injector","$rootScope","$timeout",function(a,b,c,d){return{require:["?^uiScrollViewport"],transclude:"element",priority:1e3,terminal:!0,compile:function(e,f,g){return function(e,f,h,i){var j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z;if(G=a.debug||a.log,H=h.uiScroll.match(/^\s*(\w+)\s+in\s+(\w+)\s*$/),!H)throw new Error("Expected uiScroll in form of '_item_ in _datasource_' but got '"+h.uiScroll+"'");if(E=H[1],u=H[2],C=function(a){return angular.isObject(a)&&a.get&&angular.isFunction(a.get)},t=e[u],!C(t)&&(t=b.get(u),!C(t)))throw new Error(""+u+" is not a valid datasource");return q=Math.max(3,+h.bufferSize||10),p=function(){return Y.height()*Math.max(.1,+h.padding||.1)},P=function(a){var b;return null!=(b=a[0].scrollHeight)?b:a[0].document.documentElement.scrollHeight},j=null,g(S=e.$new(),function(a){var b,c,d,e,g,h;if(e=a[0].localName,"dl"===e)throw new Error("ui-scroll directive does not support <"+a[0].localName+"> as a repeating tag: "+a[0].outerHTML);return"li"!==e&&"tr"!==e&&(e="div"),h=i[0]||angular.element(window),h.css({"overflow-y":"auto",display:"block"}),d=function(a){var b,c,d;switch(a){case"tr":return d=angular.element("<table><tr><td><div></div></td></tr></table>"),b=d.find("div"),c=d.find("tr"),c.paddingHeight=function(){return b.height.apply(b,arguments)},c;default:return c=angular.element("<"+a+"></"+a+">"),c.paddingHeight=c.height,c}},c=function(a,b,c){return b[{top:"before",bottom:"after"}[c]](a),{paddingHeight:function(){return a.paddingHeight.apply(a,arguments)},insert:function(b){return a[{top:"after",bottom:"before"}[c]](b)}}},g=c(d(e),f,"top"),b=c(d(e),f,"bottom"),S.$destroy(),j={viewport:h,topPadding:g.paddingHeight,bottomPadding:b.paddingHeight,append:b.insert,prepend:g.insert,bottomDataPos:function(){return P(h)-b.paddingHeight()},topDataPos:function(){return g.paddingHeight()}}}),Y=j.viewport,Z=Y.scope()||c,angular.isDefined(h.topVisible)&&(V=function(a){return Z[h.topVisible]=a}),angular.isDefined(h.topVisibleElement)&&(U=function(a){return Z[h.topVisibleElement]=a}),angular.isDefined(h.topVisibleScope)&&(X=function(a){return Z[h.topVisibleScope]=a}),T=function(a){return V&&V(a.scope[E]),U&&U(a.element),X&&X(a.scope),t.topVisible?t.topVisible(a):void 0},F=angular.isDefined(h.isLoading)?function(a){return Z[h.isLoading]=a,t.loading?t.loading(a):void 0}:function(a){return t.loading?t.loading(a):void 0},N=0,A=1,I=1,o=[],J=[],w=!1,m=!1,D=!1,L=function(a,b){var c,d;for(c=d=a;b>=a?b>d:d>b;c=b>=a?++d:--d)o[c].scope.$destroy(),o[c].element.remove();return o.splice(a,b-a)},K=function(){return N++,A=1,I=1,L(0,o.length),j.topPadding(0),j.bottomPadding(0),J=[],w=!1,m=!1,k(N,!1)},n=function(){return Y.scrollTop()+Y.height()},W=function(){return Y.scrollTop()},Q=function(){return!w&&j.bottomDataPos()<n()+p()},r=function(){var a,b,c,d,e,f;for(a=0,d=0,b=e=f=o.length-1;(0>=f?0>=e:e>=0)&&(c=o[b].element.outerHeight(!0),j.bottomDataPos()-a-c>n()+p());b=0>=f?++e:--e)a+=c,d++,w=!1;return d>0?(j.bottomPadding(j.bottomPadding()+a),L(o.length-d,o.length),I-=d,G("clipped off bottom "+d+" bottom padding "+j.bottomPadding())):void 0},R=function(){return!m&&j.topDataPos()>W()-p()},s=function(){var a,b,c,d,e,f;for(d=0,c=0,e=0,f=o.length;f>e&&(a=o[e],b=a.element.outerHeight(!0),j.topDataPos()+d+b<W()-p());e++)d+=b,c++,m=!1;return c>0?(j.topPadding(j.topPadding()+d),L(0,c),A+=c,G("clipped off top "+c+" top padding "+j.topPadding())):void 0},v=function(a,b,c){return D||(D=!0,F(!0)),1===J.push(b)?y(a,c):void 0},B=function(a,b){var c,d,f;return c=e.$new(),c[E]=b,d=a>A,c.$index=a,d&&c.$index--,f={scope:c},g(c,function(b){return f.element=b,d?a===I?(j.append(b),o.push(f)):(o[a-A].element.after(b),o.splice(a-A+1,0,f)):(j.prepend(b),o.unshift(f))}),{appended:d,wrapper:f}},l=function(a,b){var c;return a?j.bottomPadding(Math.max(0,j.bottomPadding()-b.element.outerHeight(!0))):(c=j.topPadding()-b.element.outerHeight(!0),c>=0?j.topPadding(c):Y.scrollTop(Y.scrollTop()+b.element.outerHeight(!0)))},k=function(a,b,c,e){var f;return f=function(){var c,d,f,g,h,i;if(G("top {actual="+j.topDataPos()+" visible from="+W()+" bottom {visible through="+n()+" actual="+j.bottomDataPos()+"}"),Q()?v(a,!0,b):R()&&v(a,!1,b),e&&e(a),0===J.length){for(f=0,i=[],g=0,h=o.length;h>g;g++){if(c=o[g],d=c.element.outerHeight(!0),!(j.topDataPos()+f+d<W())){T(c);break}i.push(f+=d)}return i}},c?d(function(){var a,b,d;for(b=0,d=c.length;d>b;b++)a=c[b],l(a.appended,a.wrapper);return f()}):f()},z=function(a,b,c){return k(a,b,c,function(){return J.shift(),0===J.length?(D=!1,F(!1)):y(a,b)})},y=function(a,b){var c;return c=J[0],c?o.length&&!Q()?z(a,b):t.get(I,q,function(c){var d,e,f,g;if(!a||a===N){if(e=[],0===c.length)w=!0,j.bottomPadding(0);else for(s(),f=0,g=c.length;g>f;f++)d=c[f],e.push(B(++I,d));return z(a,b,e)}}):o.length&&!R()?z(a,b):t.get(A-q,q,function(c){var d,e,f,g;if(!a||a===N){if(e=[],0===c.length)m=!0,j.topPadding(0);else for(o.length&&r(),d=f=g=c.length-1;0>=g?0>=f:f>=0;d=0>=g?++f:--f)e.unshift(B(--A,c[d]));return z(a,b,e)}})},M=function(){return c.$$phase||D?void 0:(k(null,!1),e.$apply())},Y.bind("resize",M),O=function(){return c.$$phase||D?void 0:(k(null,!0),e.$apply())},Y.bind("scroll",O),e.$watch(t.revision,function(){return K()}),x=t.scope?t.scope.$new():e.$new(),e.$on("$destroy",function(){return x.$destroy(),Y.unbind("resize",M),Y.unbind("scroll",O)}),x.$on("update.items",function(a,b,c){var d,e,f,g,h;if(angular.isFunction(b))for(e=function(a){return b(a.scope)},f=0,g=o.length;g>f;f++)d=o[f],e(d);else 0<=(h=b-A-1)&&h<o.length&&(o[b-A-1].scope[E]=c);return null}),x.$on("delete.items",function(a,b){var c,d,e,f,g,h,i,j,l,m,n,p;if(angular.isFunction(b)){for(e=[],h=0,l=o.length;l>h;h++)d=o[h],e.unshift(d);for(g=function(a){return b(a.scope)?(L(e.length-1-c,e.length-c),I--):void 0},c=i=0,m=e.length;m>i;c=++i)f=e[c],g(f)}else 0<=(p=b-A-1)&&p<o.length&&(L(b-A-1,b-A),I--);for(c=j=0,n=o.length;n>j;c=++j)d=o[c],d.scope.$index=A+c;return k(null,!1)}),x.$on("insert.item",function(a,b,c){var d,e,f,g,h;if(e=[],angular.isFunction(b))throw new Error("not implemented - Insert with locator function");for(0<=(h=b-A-1)&&h<o.length&&(e.push(B(b,c)),I++),d=f=0,g=o.length;g>f;d=++f)c=o[d],c.scope.$index=A+d;return k(null,!1,e)})}}}}]);